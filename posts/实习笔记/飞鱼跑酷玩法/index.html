<!DOCTYPE html>
<html lang="en-us">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

    <title>
    
    
    GeeTeng</title>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="description" content="FishParkoutSystem.ts enum EFishState { None, Swim, //正常游泳期 Jump, //跳跃动画期 QTEJump, //QTE跳跃 QTEFail, //QTE失败 InAir, //滑行期 AirToSwim, //窗口期 Hit, //受击动画到入水期 } onCreateNodeData onCreateNodeData是在PostCreateGameDataByFlowNodeSAction这个action执行时调用的函数，也就是当注册FishParkourData之前调用这个函数，在这个函数中绑定了蓝图中的委托（OnBeginOverlap、OnInputJumpStart、OnFallingInWater）并且更新了UI，调用了一个setParkourSplinePointInfo( params.splineSpawnerId, selfActor.ParkourMovement);函数，设置组件的setActive(true)，其中params是通过如下得到。
let params = findObjectParam( action.params, SettingFishParkourNodeCreateParam ); //Define.ts export class SettingFishParkourNodeCreateParam extends SettingNodeParam { public splineSpawnerId: string = &#34;&#34;; } 这个函数在Util.ts工具类中，存入样条线全部的点。
export function setParkourSplinePointInfo(spawnerId: string, parkourMovementComponent: UE.ParkourMovementComponent) { let splinePoints = findSplinePointsBySpawnerId(spawnerId); // 返回splinePoints数组 F.assert(splinePoints); let pointTransforms = UE.NewArray(UE.Transform); for (let info of splinePoints) { // 从该数组拿到每个点 let transform = new UE.
    ">


<meta property="og:url" content="http://localhost:1313/posts/%E5%AE%9E%E4%B9%A0%E7%AC%94%E8%AE%B0/%E9%A3%9E%E9%B1%BC%E8%B7%91%E9%85%B7%E7%8E%A9%E6%B3%95/">
  <meta property="og:site_name" content="GeeTeng">
  <meta property="og:title" content="GeeTeng">
  <meta property="og:description" content="FishParkoutSystem.ts enum EFishState { None, Swim, //正常游泳期 Jump, //跳跃动画期 QTEJump, //QTE跳跃 QTEFail, //QTE失败 InAir, //滑行期 AirToSwim, //窗口期 Hit, //受击动画到入水期 } onCreateNodeData onCreateNodeData是在PostCreateGameDataByFlowNodeSAction这个action执行时调用的函数，也就是当注册FishParkourData之前调用这个函数，在这个函数中绑定了蓝图中的委托（OnBeginOverlap、OnInputJumpStart、OnFallingInWater）并且更新了UI，调用了一个setParkourSplinePointInfo( params.splineSpawnerId, selfActor.ParkourMovement);函数，设置组件的setActive(true)，其中params是通过如下得到。
let params = findObjectParam( action.params, SettingFishParkourNodeCreateParam ); //Define.ts export class SettingFishParkourNodeCreateParam extends SettingNodeParam { public splineSpawnerId: string = &#34;&#34;; } 这个函数在Util.ts工具类中，存入样条线全部的点。
export function setParkourSplinePointInfo(spawnerId: string, parkourMovementComponent: UE.ParkourMovementComponent) { let splinePoints = findSplinePointsBySpawnerId(spawnerId); // 返回splinePoints数组 F.assert(splinePoints); let pointTransforms = UE.NewArray(UE.Transform); for (let info of splinePoints) { // 从该数组拿到每个点 let transform = new UE.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="GeeTeng">
  <meta name="twitter:description" content="FishParkoutSystem.ts enum EFishState { None, Swim, //正常游泳期 Jump, //跳跃动画期 QTEJump, //QTE跳跃 QTEFail, //QTE失败 InAir, //滑行期 AirToSwim, //窗口期 Hit, //受击动画到入水期 } onCreateNodeData onCreateNodeData是在PostCreateGameDataByFlowNodeSAction这个action执行时调用的函数，也就是当注册FishParkourData之前调用这个函数，在这个函数中绑定了蓝图中的委托（OnBeginOverlap、OnInputJumpStart、OnFallingInWater）并且更新了UI，调用了一个setParkourSplinePointInfo( params.splineSpawnerId, selfActor.ParkourMovement);函数，设置组件的setActive(true)，其中params是通过如下得到。
let params = findObjectParam( action.params, SettingFishParkourNodeCreateParam ); //Define.ts export class SettingFishParkourNodeCreateParam extends SettingNodeParam { public splineSpawnerId: string = &#34;&#34;; } 这个函数在Util.ts工具类中，存入样条线全部的点。
export function setParkourSplinePointInfo(spawnerId: string, parkourMovementComponent: UE.ParkourMovementComponent) { let splinePoints = findSplinePointsBySpawnerId(spawnerId); // 返回splinePoints数组 F.assert(splinePoints); let pointTransforms = UE.NewArray(UE.Transform); for (let info of splinePoints) { // 从该数组拿到每个点 let transform = new UE.">


  <meta itemprop="name" content="GeeTeng">
  <meta itemprop="description" content="FishParkoutSystem.ts enum EFishState { None, Swim, //正常游泳期 Jump, //跳跃动画期 QTEJump, //QTE跳跃 QTEFail, //QTE失败 InAir, //滑行期 AirToSwim, //窗口期 Hit, //受击动画到入水期 } onCreateNodeData onCreateNodeData是在PostCreateGameDataByFlowNodeSAction这个action执行时调用的函数，也就是当注册FishParkourData之前调用这个函数，在这个函数中绑定了蓝图中的委托（OnBeginOverlap、OnInputJumpStart、OnFallingInWater）并且更新了UI，调用了一个setParkourSplinePointInfo( params.splineSpawnerId, selfActor.ParkourMovement);函数，设置组件的setActive(true)，其中params是通过如下得到。
let params = findObjectParam( action.params, SettingFishParkourNodeCreateParam ); //Define.ts export class SettingFishParkourNodeCreateParam extends SettingNodeParam { public splineSpawnerId: string = &#34;&#34;; } 这个函数在Util.ts工具类中，存入样条线全部的点。
export function setParkourSplinePointInfo(spawnerId: string, parkourMovementComponent: UE.ParkourMovementComponent) { let splinePoints = findSplinePointsBySpawnerId(spawnerId); // 返回splinePoints数组 F.assert(splinePoints); let pointTransforms = UE.NewArray(UE.Transform); for (let info of splinePoints) { // 从该数组拿到每个点 let transform = new UE.">
  <meta itemprop="wordCount" content="467">
<link rel="canonical" href="http://localhost:1313/posts/%E5%AE%9E%E4%B9%A0%E7%AC%94%E8%AE%B0/%E9%A3%9E%E9%B1%BC%E8%B7%91%E9%85%B7%E7%8E%A9%E6%B3%95/" />

<link rel="icon" type="image/png" href="http://localhost:1313/image/favicon.ico">

<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/bulma.min.css">

<link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/katex@0.16.11/dist/katex.min.css" />
<script defer src="https://cdn.jsdmirror.com/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdmirror.com/npm/katex@0.16.11/dist/contrib/auto-render.min.js" crossorigin="anonymous"
  onload="renderMathInElement(document.body, {
          delimiters: [
            { left: '$$', right: '$$', display: true },
            { left: '$', right: '$', display: false }
          ],
          throwOnError: false
        });"></script>



<script src=/js/ramium.js></script>
<link rel="stylesheet" href=/css/ramium.css>






</head>

<body>
    
     
    <style type="text/css">
        .fireworks {
            position: fixed;
            pointer-events: none;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
        }
        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;    
            height: 100vh;   
            z-index: -1;     
        }
    </style>
    <canvas class="fireworks"></canvas>
<script src="/js/anime.min.js"></script>
<script src="/js/fireworks.js"></script>


    <script type="text/javascript">
        fireworks.setCanvasSize();
    </script>
    <nav class="navbar is-dark" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item" href=/>
      
      <strong>GeeTeng </strong>
      
    </a>

    <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false"
      data-target="navbarBasicExample">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>

  <div id="navbarBasicExample" class="navbar-menu">
    <div class="navbar-start">
      
      
      <a class="navbar-item" href="/">Home</a>
      
      
      
      <div class="navbar-item has-dropdown is-hoverable">
        <a class="navbar-link">This Blog</a>
        <div class="navbar-dropdown">
          
          <a class="navbar-item" href="/tags/">All Tags</a>
          
          <a class="navbar-item" href="/posts/">All Posts</a>
          
        </div>
      </div>
      
      
      
      <a class="navbar-item" href="/about-me/">About Me</a>
      
      
    </div>

    <div class="navbar-end">
      

      
      <div class="navbar-item">
        <form id="cse-search-box-form-id" onsubmit="return executeQuery();" role="search">
          <div class="field has-addons">
            <div class="control is-expanded">
              <input id="cse-search-input-box-id" size=15 class="input" type="text" autocomplete="off"
                placeholder="&#xf1a0; Google search" style="font-family:Arial, FontAwesome">
            </div>

            <div class="control">
              <button type="submit" class="button is-black">
                <i class="fa fa-search"></i>
                </a>
              </button>
            </div>
          </div>
        </form>
      </div>
      
    </div>
  </div>
</nav><div class="columns is-centered">
        
        <div id="page-body" class="column is-7 is-12-mobile">

<div class="content-wrapper">
    
    
    <nav id="TableOfContents" class="table-of-contents">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#fishparkoutsystemts">FishParkoutSystem.ts</a>
          <ul>
            <li><a href="#oncreatenodedata">onCreateNodeData</a></li>
            <li><a href="#onbbvaluechanged">onBBValueChanged</a></li>
            <li><a href="#setstate--canswitchtostate">setState | canSwitchToState</a></li>
            <li><a href="#beginoverlap">beginOverlap</a></li>
            <li><a href="#oninputjump">onInputJump</a></li>
            <li><a href="#onplayingpose">onPlayingPose</a></li>
            <li><a href="#enterjumpstate">enterJumpState</a></li>
            <li><a href="#cancelwindowtimer">cancelWindowTimer</a></li>
            <li><a href="#bp-tickcheckjumpdistowater">BP-TickCheckJumpDistoWater</a></li>
            <li><a href="#onfallinginwater">onFallingInWater</a></li>
            <li><a href="#bp-changemeshangle">BP-ChangeMeshAngle</a></li>
            <li><a href="#onqteresult">onQTEResult</a></li>
            <li><a href="#enterqtejumpstate">enterQTEJumpState</a></li>
            <li><a href="#enterhitstate">enterHitState</a></li>
          </ul>
        </li>
        <li><a href="#parkourmovementcomponent">ParkourMovementComponent</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
    

    
    <div class="content blog">
        <h1></h1>

        <div id="infobar" class="level is-mobile">
            <div class="level-left">
                
                <div class="level-item">
                    <p class="subtitle info date">Jan 1, 0001
                    </p>
                </div>
                

                <div class="level-item">
                    <p class="subtitle info">
                        34 mins read
                    </p>
                </div>
            </div>
            <div class="level-right is-hidden-touch">
                <div class="tags">
                    
                </div>
            </div>
        </div>

        <div class="tags is-hidden-desktop">
            
        </div>

        <div class="blog-text">
            

            <h2 id="fishparkoutsystemts">FishParkoutSystem.ts</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Thrift" data-lang="Thrift"><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">EFishState</span> {
</span></span><span style="display:flex;"><span>    None,
</span></span><span style="display:flex;"><span>    Swim, <span style="color:#75715e">//正常游泳期
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Jump, <span style="color:#75715e">//跳跃动画期
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    QTEJump, <span style="color:#75715e">//QTE跳跃
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    QTEFail, <span style="color:#75715e">//QTE失败
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    InAir, <span style="color:#75715e">//滑行期
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    AirToSwim, <span style="color:#75715e">//窗口期
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Hit, <span style="color:#75715e">//受击动画到入水期
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="oncreatenodedata">onCreateNodeData</h3>
<p><code>onCreateNodeData</code>是在PostCreateGameDataByFlowNodeSAction这个action执行时调用的函数，也就是当注册FishParkourData之前调用这个函数，在这个函数中绑定了蓝图中的委托（OnBeginOverlap、OnInputJumpStart、OnFallingInWater）并且更新了UI，调用了一个<code>setParkourSplinePointInfo( params.splineSpawnerId, selfActor.ParkourMovement);</code>函数，设置组件的setActive(true)，其中params是通过如下得到。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-TypeScript" data-lang="TypeScript"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">params</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">findObjectParam</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">action</span>.<span style="color:#a6e22e">params</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SettingFishParkourNodeCreateParam</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Define.ts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SettingFishParkourNodeCreateParam</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">SettingNodeParam</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">splineSpawnerId</span>: <span style="color:#66d9ef">string</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这个函数在Util.ts工具类中，存入样条线全部的点。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">setParkourSplinePointInfo</span>(<span style="color:#a6e22e">spawnerId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#a6e22e">parkourMovementComponent</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">UE</span>.<span style="color:#a6e22e">ParkourMovementComponent</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">splinePoints</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">findSplinePointsBySpawnerId</span>(<span style="color:#a6e22e">spawnerId</span>); <span style="color:#75715e">// 返回splinePoints数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">F</span>.<span style="color:#a6e22e">assert</span>(<span style="color:#a6e22e">splinePoints</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">pointTransforms</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">UE</span>.<span style="color:#a6e22e">NewArray</span>(<span style="color:#a6e22e">UE</span>.<span style="color:#a6e22e">Transform</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">info</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">splinePoints</span>) { <span style="color:#75715e">// 从该数组拿到每个点
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">transform</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">UE</span>.<span style="color:#a6e22e">Transform</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">SetLocation</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">UE</span>.<span style="color:#a6e22e">Vector</span>(<span style="color:#a6e22e">info</span>.<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">info</span>.<span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">info</span>.<span style="color:#a6e22e">z</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">SetRotation</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">UE</span>.<span style="color:#a6e22e">Rotator</span>(<span style="color:#a6e22e">info</span>.<span style="color:#a6e22e">pitch</span>, <span style="color:#a6e22e">info</span>.<span style="color:#a6e22e">yaw</span>, <span style="color:#a6e22e">info</span>.<span style="color:#a6e22e">roll</span>).<span style="color:#a6e22e">Quaternion</span>()); <span style="color:#75715e">// 将欧拉角转换为四元数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">pointTransforms</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">transform</span>); <span style="color:#75715e">// 添加到pointTransforms中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">parkourMovementComponent</span>.<span style="color:#a6e22e">SetSplinePointInfo</span>(<span style="color:#a6e22e">pointTransforms</span>); <span style="color:#75715e">// 调用cpp中组件的函数将pointTeansforms赋值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>其中<code>findSplinePointsBySpawnerId</code>是在SplinePointSystem.ts中定义的。这个系统中关联的数据是SplinePointData，其中包含一个Map&lt;string, ISplinePoints&gt;splinePoints，这个ISplinePoints是包含着splinePoints数组、spawnerId和isAutoSpawn。所以这个函数会返回ISplinePoints的splinePoints数组。</p>
<p>ISplinePoints</p>
<p>|__splinePoints：ITransformData[]</p>
<p>|__SpawnerId：string</p>
<p>|__isAutoSpawn：boolean</p>
<h3 id="onbbvaluechanged">onBBValueChanged</h3>
<p><code>onBBValueChanged</code>这个函数是在FlowBlackboardValueChangedEvent触发时调用的，也就是当黑板键值改变会判断键是否为bFishEnterWaterFall，代表飞鱼是否进入瀑布，如果进入瀑布event.newValue=true，那么就设置bCanCtrl=false飞鱼不可以控制，否则可以控制。这个bCanCtrl在蓝图中是可以控制是否能跳跃和移动的开关。</p>
<h3 id="setstate--canswitchtostate">setState | canSwitchToState</h3>
<p><code>setState</code>会先调用<code>canSwitchToState</code>判断是否能够切换到目标状态<code>canSwitchToState</code>会返回一个bool值用来判断是否可以切换状态，比如说我要切换到InAir状态，那么就一定得是从Jump状态或者QTEJump状态。之后<code>setState</code>然后会执行<code>exitState</code>退出当前状态（如果当前状态是在空中（要从空中状态切换出去）那么bFalling=false，动画蓝图中的bInAir=false，这个bInAir会在<code>enterInAirState</code>中变为true），exitState逻辑是根据不同的状态选择要执行的逻辑，比如说我现在要切换状态到Jump那么就会SetState(Jump)然后进入到这个函数里执行this.enterJumpState(oldStatus);七个状态分别对应七个函数。</p>
<h3 id="beginoverlap">beginOverlap</h3>
<p><code>beginOverlap</code>是当飞鱼撞到障碍物时被调用，如果otherActor的tag时Obstacle那么就销毁otherActor并setState(Hit)。这个tag是在地图中的actor中设置的。</p>
<h3 id="oninputjump">onInputJump</h3>
<p><code>onInputJump</code>是在跳跃键被触发时调用，如果是swim和AirToSwim状态就setState(Jump)直接return，否则调用<code>onPlayPose</code>（播放摇摆尾巴动画）。这也是为什么canSwitchToState中判断了状态切换条件仍然需要在onInputJump中判断一次。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-TypeScript" data-lang="TypeScript"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#a6e22e">onInputJump() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fishComponent</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">FishParkourSingletonData</span>.<span style="color:#a6e22e">getSingleton</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 因为需要调用onPlayPose所以要再判断一次
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">fishState</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">EFishState</span>.<span style="color:#a6e22e">Swim</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">fishState</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">EFishState</span>.<span style="color:#a6e22e">AirToSwim</span>
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">setState</span>(<span style="color:#a6e22e">EFishState</span>.<span style="color:#a6e22e">Jump</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">onPlayPose</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="onplayingpose">onPlayingPose</h3>
<p><code>onPlayPose</code>中如果在空中并且不在播放动画，那么播放摇摆尾巴，并且启用定时器延时1s（动画播放时间）记录timerId，存储到data中。这是为了防止其他动画打断它（因为受击或者跳跃也会播放动画），在动画播放结束后定时器会清空Timer并设置bPlayingPose为false。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">fishState</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">EFishState</span>.<span style="color:#a6e22e">InAir</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">!</span><span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">bPlayingPose</span>
</span></span><span style="display:flex;"><span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">playMontageFish</span>(<span style="color:#a6e22e">FishTailing_Montage_Id</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">timerId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">addTimer</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">id</span>,
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">component</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Readonly</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FishParkourSingletonData</span><span style="color:#f92672">&gt;</span>) =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modify</span>(<span style="color:#a6e22e">component</span>, (<span style="color:#a6e22e">v</span>) =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">poseTimer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">bPlayingPose</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modify</span>(<span style="color:#a6e22e">fishComponent</span>, (<span style="color:#a6e22e">v</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">poseTimer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">timerId</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">bPlayingPose</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="enterjumpstate">enterJumpState</h3>
<p>如果进入到setState(Jump)那就会调用<code>enterJumpState</code></p>
<ul>
<li>如果在swim状态则跳跃速度是NormalJumpZVelocity</li>
<li>如果是AirToSwim状态则分为两种情况：
<ul>
<li>达到最大暴击次数 则CriticalJumpZVelocity 并且criticalNumber = 0</li>
<li>未达到最大暴击次数 则ContJumpZVelocity 并且criticalNumber ++</li>
</ul>
</li>
</ul>
<p>设置CharacterMovement.JumpZVelocity=对应情况的速度，然后调用<code>selfActor.Jump()</code>，播放跳跃动画。</p>
<h3 id="cancelwindowtimer">cancelWindowTimer</h3>
<p>这个函数会被调用三次，分别在<code>enterHitState</code>、<code>enterQTEJumpState</code>、<code>enterJumpState</code>，作用是移除windowTimer定时器并设置windowTimer=undefined、windowTimer=false。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">cancelWindowTimer</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">timerId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">addTimer</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">id</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">component</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Readonly</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FishParkourSingletonData</span><span style="color:#f92672">&gt;</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">setState</span>(<span style="color:#a6e22e">EFishState</span>.<span style="color:#a6e22e">InAir</span>); <span style="color:#75715e">// 0.2秒后切换到InAir状态 并置空jumpAnimTimer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modify</span>(<span style="color:#a6e22e">component</span>, (<span style="color:#a6e22e">v</span>) =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">jumpAnimTimer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modify</span>(<span style="color:#a6e22e">fishComponent</span>, (<span style="color:#a6e22e">v</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">jumpAnimTimer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">timerId</span>;
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>也就是在按下跳跃键0.2秒会触发<code>enterInAirState</code>函数，在这个函数内部会将<code>bInAir = true</code>（为了切换动画机的状态），将<code>bFalling = true</code>。<strong>总而言之bFalling代表着是否下落，在空中时会变为true；在从空中状态切换到其他状态时exitStatus变为false。</strong></p>
<p><strong>BP_PlayerFish</strong>是飞鱼的蓝图，事件图表中绑定了OnBeginOverlap、OnInputJumpStart回调函数（ts），以及EventTick每帧调用<code>TickCheckJumpDistoWater</code>和<code>ChangeMeshAngle</code>两个蓝图中创建的函数。</p>
<h3 id="bp-tickcheckjumpdistowater">BP-TickCheckJumpDistoWater</h3>
<p>其中<code>TickCheckJumpDistoWater</code>逻辑：如果bFalling=true（上一帧在下落）并且bReduceSpeed=false（没有在减速）那么就再判断当前帧是否在下落，如果没有在下落，那就把bFalling置为false，并且CallOnFallingInWater（bFalling状态从isFalling到!IsFalling的切换判断为刚好入水）。</p>
<ul>
<li>bReduceSpeed是在enterQTEJumpState时开始时变为True，然后经过很短的时间后变为False，是因为要减速有一个起跳的放慢的感觉，在ParkourMovementComponent中的tickcomponent如下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-TypeScript" data-lang="TypeScript"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">bAutoMove</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SelfPawn</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">AddMovementInput</span>(<span style="color:#a6e22e">SelfPawn</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">GetActorForwardVector</span>(), <span style="color:#a6e22e">bReduceSpeed</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">ReduceSpeedScale</span> : <span style="color:#66d9ef">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其中<strong>bAutoMove</strong>含义是：是否能自动移动，当落水时onFallingInWater和QTE失败时enterQTEFailState会设置为true，而enterQTEJumpState会设置为false。</p>
<ul>
<li>bReduceSpeed在enterHitState也会变为true，结束后变为false。因为受击也需要减速。</li>
</ul>
<p><strong>总而言之在受击和QTE跳跃时会减速</strong>，并不会进入到蓝图中的TickCheckJumpDistoWater逻辑。</p>
<h3 id="onfallinginwater">onFallingInWater</h3>
<p>这个函数是进入到AirToSwim落水窗口期的函数，它是通过蓝图中的TickCheckJumpDisToWater来一直判断是否进入窗口期，然后Call On Falling in Water。</p>
<p>这个函数主要做了以下事情：</p>
<p>判断是否在快落地时按下跳跃键（如果按下会播放摇摆尾动作bPlayPose=true）是无法触发窗口期，就只能切换成Swim状态。</p>
<p>然后设置一个定时器，在窗口时间WindowTime结束后将Timer置空bInJumpWindow=false。</p>
<p>切换到AirToSwim状态，目前该状态没有写逻辑，主要是做一些播放特效。另外就是为了在下次按下跳跃键进入跳跃逻辑时会执行else分支（暴击次数和不同的跳跃高度）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-TypeScript" data-lang="TypeScript"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#a6e22e">onFallingInWater() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fishComponent</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">FishParkourSingletonData</span>.<span style="color:#a6e22e">getSingleton</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">selfActor</span>.<span style="color:#a6e22e">ParkourMovement</span>.<span style="color:#a6e22e">bAutoMove</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">bPlayingPose</span>) { <span style="color:#75715e">// bPlayingPose是在已经跳跃时按下跳跃键的时候会为true 这个时候是不能触发窗口期的！
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">setState</span>(<span style="color:#a6e22e">EFishState</span>.<span style="color:#a6e22e">Swim</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">timerId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">addTimer</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">id</span>,
</span></span><span style="display:flex;"><span>            (<span style="color:#a6e22e">component</span>: <span style="color:#66d9ef">Readonly</span>&lt;<span style="color:#f92672">FishParkourSingletonData</span>&gt;) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modify</span>(<span style="color:#a6e22e">component</span>, (<span style="color:#a6e22e">v</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">windowTimer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">bInJumpWindow</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">setState</span>(<span style="color:#a6e22e">EFishState</span>.<span style="color:#a6e22e">Swim</span>);
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">selfActor</span>.<span style="color:#a6e22e">WindowTime</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modify</span>(<span style="color:#a6e22e">fishComponent</span>, (<span style="color:#a6e22e">v</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">windowTimer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">timerId</span>;
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">setState</span>(<span style="color:#a6e22e">EFishState</span>.<span style="color:#a6e22e">AirToSwim</span>); <span style="color:#75715e">// 转换到窗口期状态 之后再次跳跃会在enterJumpState里判断是否当前状态是AirToSwim
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="bp-changemeshangle">BP-ChangeMeshAngle</h3>
<p><code>ChangeMeshAngle</code>是为了改变飞鱼在向上坡游动时的角色旋转方向，characterMovement中的currentfloor能够获取角色当前脚下的地面信息，从中取到CurrentFloorHitResult中的ImpactNormal能够拿到地面的法线方向，然后和（0，0，1）进行一个点乘会得到法线与Z轴的夹角余弦=》如果地面完全水平则点乘结果是1，如果是垂直墙壁则是0，然后将结果求ACOSd（反余弦）将余弦值转换成角度会得到一个度数。所以**点积常用来求角度的余弦值而叉积常用来求法线方向、判断左右位置关系。**之后就可以SetRelativeRotation传入坡度角度的负数。</p>
<blockquote>
<p>为什么要解决重力的问题？</p>
</blockquote>
<p>因为飞鱼向坡上游动时，跳跃会跳不高，是因为当飞鱼在平地时起跳力是完全对抗重力的，但是在坡面时起跳方向是坡面的法线方向，分量会浪费在水平方向上，所以会跳不高。</p>
<p>CharacterMovement中有一个GravityScale是重力缩放因子，会影响Z方向的加速度，=1时是正常重力，=0是漂浮。当角色走在不同坡度的地面时，不可能用同样的重力，否则会不自然，所以需要将刚才求到的坡度角度Sin值，Sin(AngleDeg)越大坡面越陡，用1-Sin(AngleDeg)=》坡面越陡越接近0，之后×BaseGravityScale得到实际的重力。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#66d9ef">float</span> AngleDeg <span style="color:#f92672">=</span> FMath<span style="color:#f92672">::</span>Acosd(Normal <span style="color:#960050;background-color:#1e0010">·</span> UpVector);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> Factor <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> FMath<span style="color:#f92672">::</span>Sin(AngleDeg);
</span></span><span style="display:flex;"><span>GravityScale <span style="color:#f92672">=</span> BaseGravityScale <span style="color:#f92672">*</span> Factor;
</span></span></code></pre></div><h3 id="onqteresult">onQTEResult</h3>
<p><code>onQTEResult</code>是通过QTEResultEvent这个event触发，当action.bSucceed=true时setState(QTEJump)否则setState(QTEFail)QTE失败。</p>
<h3 id="enterqtejumpstate">enterQTEJumpState</h3>
<p>在enterQTEJumpState中减速，并且通过qteCount判断第几次QTE跳跃来设置不同的跳跃高度。</p>
<p>和跳跃一样播放跳跃蒙太奇，然后添加定时器SetState(InAir) 和jumpAnimTimer=undefined，如果被打断（Hit）的话可以清空，如果没被打断依然会通过定时器设置undefined.</p>
<h3 id="enterhitstate">enterHitState</h3>
<p>hit中先会减速然后取消播放跳跃（QTE跳跃和普通跳跃）和在空中跳跃摇摆尾的动作的定时器。而WindowTimer是落水时赋值封装在cancelWindowTimer中，Jump、QUEJump和Hit中调用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">jumpAnimTimer</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">removeTimer</span>(<span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">jumpAnimTimer</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modify</span>(<span style="color:#a6e22e">fishComponent</span>, (<span style="color:#a6e22e">v</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">jumpAnimTimer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">poseTimer</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">removeTimer</span>(<span style="color:#a6e22e">fishComponent</span>.<span style="color:#a6e22e">poseTimer</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modify</span>(<span style="color:#a6e22e">fishComponent</span>, (<span style="color:#a6e22e">v</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">bPlayingPose</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">poseTimer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">cancelWindowTimer</span>();
</span></span></code></pre></div><h2 id="parkourmovementcomponent">ParkourMovementComponent</h2>
<p>ParkourMovementComponent是一个移动组件继承UActorComponent，用于处理飞鱼沿着样条线移动。通过<code>TickComponent</code>来实现每一帧向前移动，并平滑飞鱼的转向RInterp。在<code>BeginPlay</code>中先SetComponentTickEnable(false)，因为要等待TS中的<code>onCreateNodeData</code>逻辑都执行完了（之前有说明该函数）再开始Tick逻辑（通过<code>SetActive</code>）。还有一个<code>FindRotationClosestToWorldLocation</code>倒序遍历样条线上的点，然后找到离飞鱼当前位置最近的点，返回该点的Rotator。</p>
<p>所以总流程是如下：</p>
<p>飞鱼沿着样条线自动向前移动，玩家可操控左右和跳跃键来躲避瀑布的碎石，其中在窗口期跳跃会触发暴击跳跃；进入瀑布区域玩家失去控制权，只接受来自QTE跳跃机制。目前无论玩家QTE成功与失败都会触发跳跃，失败会额外触发受击效果。</p>
<blockquote>
<p>如何判断入水窗口期？</p>
</blockquote>
<p>通过在BP中Tick检查上一帧与该帧的isFalling状态是否不同，即上一帧isFalling=true而下一帧是false，则调用入水窗口期的回调函数，设置飞鱼状态为窗口期。在指定时间后更改状态为游泳状态，如果在更改状态之前触发了跳跃，即从窗口期&mdash;-&gt;跳跃，则会增加暴击次数，并且更改跳跃速度。</p>
<blockquote>
<p>如何进入QTE跳跃？</p>
</blockquote>
<p>QTETrigger会被种在场景中，通过流程图飞鱼进入该Trigger会触发QTE系统的StartQTE(OperationStartQTE)对应FlowOperationStartQTENodeSystem.ts，其中PostStartFlowNodeSAction节点开始后会触发onExecute函数，在这个函数中会调用<code>startQTE(node.id, node.qteTemplateId);</code> qteTemplateId在xls表中对应clickQTE，而startQTE在QTESystem中实现。</p>
<p>startQTE中主要做了通过changeInput清空当前输入，然后绑定xls表中对应的输入映射，然后加载输入映射资源到增强输入系统，之后_QTEStartAction广播会被QTEParentSystem接收到，根据QTE限制的时间启动倒计时定时器，当时间结束后会触发onTmeEnd函数表示QTE失败，之后会调整全局时间流速。</p>
<p>那么QTE成功是被谁通知的呢？通过子系统ClickQTESystem，如下代码是子系统中的onBindCallBack，当_QTEBindIAAction时会被触发。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-TypeScript" data-lang="TypeScript"><span style="display:flex;"><span><span style="color:#75715e">// 回调绑定函数 当玩家触发按键时会调用该函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">handle</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">selfCharacter</span>.<span style="color:#a6e22e">BindInputActionCallBack</span>(<span style="color:#a6e22e">action</span>.<span style="color:#a6e22e">inputAction</span>, <span style="color:#a6e22e">UE</span>.<span style="color:#a6e22e">ETriggerEvent</span>.<span style="color:#a6e22e">Started</span>, <span style="color:#a6e22e">toManualReleaseDelegate</span>((<span style="color:#a6e22e">ActionValue</span>: <span style="color:#66d9ef">UE.InputActionValue</span>, <span style="color:#a6e22e">ElapsedTime</span>: <span style="color:#66d9ef">number</span>, <span style="color:#a6e22e">TriggeredTime</span>: <span style="color:#66d9ef">number</span>, <span style="color:#a6e22e">SourceAction</span>: <span style="color:#66d9ef">$Nullable</span>&lt;<span style="color:#f92672">UE.InputAction</span>&gt;) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">bSucceed</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#75715e">// 已经成功了就直接返回 防止反复触发
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modify</span>(<span style="color:#a6e22e">data</span>, (<span style="color:#a6e22e">v</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">bSucceed</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_QTESuccessAction</span>.<span style="color:#66d9ef">do</span>(<span style="color:#a6e22e">parent</span>); <span style="color:#75715e">// 广播QTE成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">button1</span>.<span style="color:#a6e22e">PlayAnimation</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">button1</span>.<span style="color:#a6e22e">AnimOnSuccess</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}));
</span></span></code></pre></div><p>所以在QTE创建时，QTEParent系统中bindInputCallBack会被调用去绑定按键，广播_QTEBindIAAction被子系统接收到onBindCallBack，子系统调用玩家的c++中BindInputActionCallBack函数去监听是否按下按键，如果按下就广播_QTESuccessAction，这个行为会被QTEParent系统接收到，最终广播_QTEResultEvent。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-TypeScript" data-lang="TypeScript"><span style="display:flex;"><span><span style="color:#66d9ef">@D</span>.<span style="color:#a6e22e">on</span>(<span style="color:#a6e22e">QTEParentData</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#a6e22e">onSuccess</span>(<span style="color:#a6e22e">action</span>: <span style="color:#66d9ef">_QTESuccessAction</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">action</span>.<span style="color:#a6e22e">getGameData</span>&lt;<span style="color:#f92672">QTEParentData</span>&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">onFinish</span>(<span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#a6e22e">onTimeEnd</span>(<span style="color:#a6e22e">data</span>: <span style="color:#66d9ef">Readonly</span>&lt;<span style="color:#f92672">QTEParentData</span>&gt;) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">onFinish</span>(<span style="color:#a6e22e">data</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#a6e22e">onFinish</span>(<span style="color:#a6e22e">data</span>: <span style="color:#66d9ef">Readonly</span>&lt;<span style="color:#f92672">QTEParentData</span>&gt;, <span style="color:#a6e22e">bSuccess</span>: <span style="color:#66d9ef">boolean</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_QTEResultEvent</span>.<span style="color:#a6e22e">dispatch</span>(<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">bSuccess</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>而_QTEResultEvent又会被飞鱼系统监听到，如果action.bSucceed = true切换到QTEJump状态。否则切换到QTEFail状态（减速，向后退，播放手机动画）。</p>

        </div>
    </div>
</div><div id="social-media-share" class="has-text-centered">
	<p><i>Sharing is caring!</i></p>
	<br>
	
	<div class="share-buttons">
	    <a  href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E5%25AE%259E%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%2f%25E9%25A3%259E%25E9%25B1%25BC%25E8%25B7%2591%25E9%2585%25B7%25E7%258E%25A9%25E6%25B3%2595%2f"
	        onclick="socialMediaPopUp(this.href, '', 500, 500); return false;"
	        title="Share on Facebook. Opens in a new window.">
	        <img src=/img/icons/45px/facebook.png>
	    </a>

	    <a  href="https://twitter.com/intent/tweet?text=&url=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E5%25AE%259E%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%2f%25E9%25A3%259E%25E9%25B1%25BC%25E8%25B7%2591%25E9%2585%25B7%25E7%258E%25A9%25E6%25B3%2595%2f"
	        onclick="socialMediaPopUp(this.href, '', 500, 500); return false;"
	        title="Share on Twitter. Opens in a new window." >
	        <img src=/img/icons/45px/twitter.png>
	    </a>

		<a  href="http://www.reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E5%25AE%259E%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%2f%25E9%25A3%259E%25E9%25B1%25BC%25E8%25B7%2591%25E9%2585%25B7%25E7%258E%25A9%25E6%25B3%2595%2f"
	        onclick="socialMediaPopUp(this.href, '', 900, 500); return false;"
	        title="Share on Reddit. Opens in a new window." >
	        <img src=/img/icons/45px/reddit.png>
	    </a>

	    <a  href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E5%25AE%259E%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%2f%25E9%25A3%259E%25E9%25B1%25BC%25E8%25B7%2591%25E9%2585%25B7%25E7%258E%25A9%25E6%25B3%2595%2f"
	        onclick="socialMediaPopUp(this.href, '', 900, 500); return false;"
	        title="Share on Pinterest. Opens in a new window." >
	        <img src=/img/icons/45px/pinterest.png>
	    </a>

	    <a  href="http://www.tumblr.com/share/link?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E5%25AE%259E%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%2f%25E9%25A3%259E%25E9%25B1%25BC%25E8%25B7%2591%25E9%2585%25B7%25E7%258E%25A9%25E6%25B3%2595%2f"
	        onclick="socialMediaPopUp(this.href, '', 900, 500); return false;"
	        title="Share on Tumblr. Opens in a new window." >
	        <img src=/img/icons/45px/tumblr.png>
	    </a>

		<a  href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E5%25AE%259E%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%2f%25E9%25A3%259E%25E9%25B1%25BC%25E8%25B7%2591%25E9%2585%25B7%25E7%258E%25A9%25E6%25B3%2595%2f
			&title=&summary=FishParkoutSystem.ts%20enum%20EFishState%20%7b%20None%2c%20Swim%2c%20%2f%2f%e6%ad%a3%e5%b8%b8%e6%b8%b8%e6%b3%b3%e6%9c%9f%20Jump%2c%20%2f%2f%e8%b7%b3%e8%b7%83%e5%8a%a8%e7%94%bb%e6%9c%9f%20QTEJump%2c%20%2f%2fQTE%e8%b7%b3%e8%b7%83%20QTEFail%2c%20%2f%2fQTE%e5%a4%b1%e8%b4%a5%20InAir%2c%20%2f%2f%e6%bb%91%e8%a1%8c%e6%9c%9f%20AirToSwim%2c%20%2f%2f%e7%aa%97%e5%8f%a3%e6%9c%9f%20Hit%2c%20%2f%2f%e5%8f%97%e5%87%bb%e5%8a%a8%e7%94%bb%e5%88%b0%e5%85%a5%e6%b0%b4%e6%9c%9f%20%7d%20onCreateNodeData%20onCreateNodeData%e6%98%af%e5%9c%a8PostCreateGameDataByFlowNodeSAction%e8%bf%99%e4%b8%aaaction%e6%89%a7%e8%a1%8c%e6%97%b6%e8%b0%83%e7%94%a8%e7%9a%84%e5%87%bd%e6%95%b0%ef%bc%8c%e4%b9%9f%e5%b0%b1%e6%98%af%e5%bd%93%e6%b3%a8%e5%86%8cFishParkourData%e4%b9%8b%e5%89%8d%e8%b0%83%e7%94%a8%e8%bf%99%e4%b8%aa%e5%87%bd%e6%95%b0%ef%bc%8c%e5%9c%a8%e8%bf%99%e4%b8%aa%e5%87%bd%e6%95%b0%e4%b8%ad%e7%bb%91%e5%ae%9a%e4%ba%86%e8%93%9d%e5%9b%be%e4%b8%ad%e7%9a%84%e5%a7%94%e6%89%98%ef%bc%88OnBeginOverlap%e3%80%81OnInputJumpStart%e3%80%81OnFallingInWater%ef%bc%89%e5%b9%b6%e4%b8%94%e6%9b%b4%e6%96%b0%e4%ba%86UI%ef%bc%8c%e8%b0%83%e7%94%a8%e4%ba%86%e4%b8%80%e4%b8%aasetParkourSplinePointInfo%28%20params.splineSpawnerId%2c%20selfActor.ParkourMovement%29%3b%e5%87%bd%e6%95%b0%ef%bc%8c%e8%ae%be%e7%bd%ae%e7%bb%84%e4%bb%b6%e7%9a%84setActive%28true%29%ef%bc%8c%e5%85%b6%e4%b8%adparams%e6%98%af%e9%80%9a%e8%bf%87%e5%a6%82%e4%b8%8b%e5%be%97%e5%88%b0%e3%80%82%0alet%20params%20%3d%20findObjectParam%28%20action.params%2c%20SettingFishParkourNodeCreateParam%20%29%3b%20%2f%2fDefine.ts%20export%20class%20SettingFishParkourNodeCreateParam%20extends%20SettingNodeParam%20%7b%20public%20splineSpawnerId%3a%20string%20%3d%20%26%2334%3b%26%2334%3b%3b%20%7d%20%e8%bf%99%e4%b8%aa%e5%87%bd%e6%95%b0%e5%9c%a8Util.ts%e5%b7%a5%e5%85%b7%e7%b1%bb%e4%b8%ad%ef%bc%8c%e5%ad%98%e5%85%a5%e6%a0%b7%e6%9d%a1%e7%ba%bf%e5%85%a8%e9%83%a8%e7%9a%84%e7%82%b9%e3%80%82%0aexport%20function%20setParkourSplinePointInfo%28spawnerId%3a%20string%2c%20parkourMovementComponent%3a%20UE.ParkourMovementComponent%29%20%7b%20let%20splinePoints%20%3d%20findSplinePointsBySpawnerId%28spawnerId%29%3b%20%2f%2f%20%e8%bf%94%e5%9b%9esplinePoints%e6%95%b0%e7%bb%84%20F.assert%28splinePoints%29%3b%20let%20pointTransforms%20%3d%20UE.NewArray%28UE.Transform%29%3b%20for%20%28let%20info%20of%20splinePoints%29%20%7b%20%2f%2f%20%e4%bb%8e%e8%af%a5%e6%95%b0%e7%bb%84%e6%8b%bf%e5%88%b0%e6%af%8f%e4%b8%aa%e7%82%b9%20let%20transform%20%3d%20new%20UE.&source=rafed123.github.io"
	        onclick="socialMediaPopUp(this.href, '', 900, 500); return false;"
	        title="Share on LinkedIn. Opens in a new window." >
	        <img src=/img/icons/45px/linkedin.png>
	    </a>

	    <a  href="mailto:?subject=&amp;body=Check out this site http%3a%2f%2flocalhost%3a1313%2fposts%2f%25E5%25AE%259E%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%2f%25E9%25A3%259E%25E9%25B1%25BC%25E8%25B7%2591%25E9%2585%25B7%25E7%258E%25A9%25E6%25B3%2595%2f"
	        title="Share via Email. Opens in a new window." >
	        <img src=/img/icons/45px/mail.png>
	    </a>
	</div>
</div>


<br>
<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        var disqus_shortname = 'disqus-code';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


        </div>
    </div>


    <div id="particles-js"></div>
    <script src="/js/particles.min.js"></script>
    <script>
        particlesJS.load('particles-js', '/js/particlesjs-config.json', function() {
            console.log('callback - particles.js config loaded');
        });
    </script>
</body>

</html>
